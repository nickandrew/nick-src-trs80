;free.asm: Source code for FREE command
;For Zeta Rtrs only (uses devices).
;
*GET	DOSCALLS
*GET	EXTERNAL
*GET	ASCII
;
	ORG	PROG_START
	DEFW	BASE
	DEFW	THIS_PROG_END
	DEFW	TERMINATE
	DEFW	TERMINATE
;End of program load info.
;
	COM	'<Free 1.2a 12-Jan-88>'
	ORG	BASE+100H
START	LD	SP,START
	LD	IY,4380H
	CALL	PUTCR
	JR	DO_FREE
;
;
USAGE
	LD	HL,M_USAGE
	CALL	MESS
	JP	TERMINATE
EXIT
	OR	A
	JP	Z,TERMINATE
	PUSH	AF
	OR	80H
	CALL	DOS_ERROR
	POP	AF
	JP	TERMINATE
;
DO_FREE
	LD	A,(HL)
	CP	0DH
	JR	NZ,USAGE
;
	LD	C,0
FREE_1
	CALL	TITLE
	JR	Z,FREE_2
	CP	20H
	JP	Z,FREE_3
	CP	08H
	JR	Z,FREE_2
	JP	EXIT
;
FREE_2
	INC	C
	JR	FREE_1
;
FREE_3	LD	A,0
	JR	EXIT
;
;
TITLE	LD	A,C	;*
	CALL	47ECH
	RET	NZ
	PUSH	BC
	LD	B,0H
	LD	HL,D_NUMB
	LD	DE,AGE
	CALL	AFU
	LD	A,(430DH)
	LD	C,A
	LD	B,0H
	LD	HL,D_TKS
	CALL	AFS
	XOR	A
	CALL	490AH
	JR	NZ,AFC
	LD	BC,0H
AEW	LD	E,(IY-71H)	;430F = GPL
	LD	A,(HL)
	INC	HL
AEX	RRCA	
	JR	C,AEY
	INC	BC
AEY	DEC	E
	JR	NZ,AEX
	LD	A,L
	CP	(IY-75H)	;430B = TRKS
	JR	C,AEW
	LD	HL,D_GRN
;Calculate in K too.
	LD	(GRANS),BC
;
	CALL	AFT
	LD	HL,42D0H
	LD	DE,D_NAME
	LD	BC,8
	LDIR	
	LD	DE,D_DATE
	LD	C,8
	LDIR	
	LD	A,1H
	CALL	490AH
	JR	NZ,AFC
AEZ	LD	A,(421FH)	;Number of dir sectors
	ADD	A,8H
	LD	E,A
AFA	LD	A,(HL)
	OR	A
	INC	HL
	JR	NZ,AFB
	INC	BC
AFB	DEC	E
	JR	NZ,AFA
	LD	A,L
	ADD	A,1FH
	AND	0E0H
	LD	L,A
	JR	NZ,AEZ
;;	LD	HL,D_FDS
;;	CALL	AFS
;
;Figure out K instead ... and put it in.
	LD	HL,(GRANS)
	PUSH	HL
	POP	DE
	ADD	HL,HL
	ADD	HL,HL
	ADD	HL,DE
	SRL	H
	RR	L
	SRL	H
	RR	L
	PUSH	HL
	POP	BC
	LD	HL,D_K
	CALL	AFT
;
	LD	HL,MSG
	CALL	MESS
	XOR	A
AFC	POP	BC		;*
	RET	
;
PUTCR
	LD	A,CR
	JR	PUTC
;
MESS	PUSH	DE
	LD	DE,DCB_2O
	CALL	MESS_0
	POP	DE
	RET
;
PUTC	PUSH	DE
	PUSH	AF
	LD	DE,DCB_2O
	CALL	ROM@PUT
	POP	AF
	POP	DE
	RET	
;
AFS	LD	DE,AGD		;*
	JR	AFU
;
AFT	LD	DE,AGC		;*
AFU	XOR	A		;*
AFV	PUSH	DE		;*
	PUSH	HL
	PUSH	BC
	EX	DE,HL
	LD	E,(HL)
	INC	HL
	LD	D,(HL)
	INC	HL
	LD	C,(HL)
	LD	B,2FH
	POP	HL
AFW	INC	B
	ADD	HL,DE
	ADC	A,C
	JR	C,AFW
	OR	A
	SBC	HL,DE
	SBC	A,C
	EX	(SP),HL
	PUSH	AF
	LD	A,(HL)
	SUB	'0'
	CP	0AH
	INC	HL
	LD	(HL),B
	JR	C,AFX
	LD	A,B
	CP	30H
	JR	NZ,AFX
	LD	(HL),20H
AFX	LD	A,E
	CP	0F6H
	JR	Z,AFY
	POP	AF
	POP	BC
	POP	DE
	INC	DE
	INC	DE
	INC	DE
	JR	AFV
AFY	POP	DE
	POP	BC
	POP	DE
	INC	HL
	LD	A,C
	ADD	A,'0'
	LD	(HL),A
	INC	HL
	RET	
;
*GET	ROUTINES
;
GRANS	DEFW	0
;
AFZ	DEFW	86A0H	;=100,000
	DEFB	1
AGA	DEFW	-10000
	DEFB	0FFH
AGC	DEFW	-1000
	DEFB	0FFH
AGD	DEFW	-100
	DEFB	0FFH
AGE	DEFW	-10
	DEFB	0FFH
ADM	DEFM	'   '
M_USAGE	DEFM	'Free:  Find free space on all drives.',CR
	DEFM	'Usage: FREE',CR,0
MSG	DEFM	'Drive'
D_NUMB	DEFM	' 00 '
D_NAME	DEFM	'XXXXXXXX '
D_DATE	DEFM	'MM/DD/YY '
D_TKS	DEFM	' 000 Tracks '
;;D_FDS	DEFM	' 000 Fdes '
D_K	DEFM	' 0000 Kbytes '
D_GRN	DEFM	' 0000 Grans',CR,0
THIS_PROG_END
	NOP	
	END	START
