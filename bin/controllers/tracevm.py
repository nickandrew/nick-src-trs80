"""Traces virtual machine opcode fetch and execute loop."""

class Controller(object):
  """A Controller executes a debugging scenario - setting breakpoints, running code etc."""

  opcode_table = {
    0x00: 'push2 wt3 43ba',
    0x01: 'push2 wt3 43bc',
    0x02: 'push2 wt3 43be',
    0x03: 'push2 wt3 43c0',
    0x04: 'push2 wt3 43c2',
    0x05: 'push2 wt3 43c4',
    0x06: 'push2 wt3 43c6',
    0x07: 'push2 wt3 43c8',
    0x08: 'push2 wt3 43ca',
    0x09: 'push2 wt3 43cc',
    0x0a: 'push2 wt3 43ce',
    0x0b: 'push2 wt3 43d0',
    0x0c: 'push2 wt3 43d2',
    0x0d: 'push2 wt3 43d4',
    0x0e: 'push2 wt3 43d6',
    0x0f: 'push2 wt3 43d8',
    0x10: 'push2 wt3 43da',
    0x11: 'push2 wt3 43dc',
    0x12: 'push2 wt3 43de',
    0x13: 'push2 wt3 43e0',
    0x14: 'push2 wt3 43e2',
    0x15: 'push2 wt3 43e4',
    0x16: 'push2 wt3 43e6',
    0x17: 'push2 wt3 43e8',
    0x18: 'push2 wt3 43ea',
    0x19: 'push2 wt3 43ec',
    0x1a: 'push2 wt3 43ee',
    0x1b: 'push2 wt3 43f0',
    0x1c: 'push2 wt3 43f2',
    0x1d: 'push2 wt3 43f4',
    0x1e: 'push2 wt3 43f6',
    0x1f: 'push2 wt3 43f8',
    0x20: 'push2 wt3 43fa',
    0x21: 'push2 wt3 43fc',
    0x22: 'push2 wt3 43fe',
    0x23: 'push2 wt3 4400',
    0x24: 'push2 wt3 4402',
    0x25: 'push2 wt3 4404',
    0x26: 'push2 wt3 4406',
    0x27: 'push2 wt3 4408',
    0x28: 'push2 wt3 440a',
    0x29: 'push2 wt3 440c',
    0x2a: 'push2 wt3 440e',
    0x2b: 'push2 wt3 4410',
    0x2c: 'push2 wt3 4412',
    0x2d: 'push2 wt3 4414',
    0x2e: 'push2 wt3 4416',
    0x2f: 'push2 wt3 4418',
    0x30: 'push2 wt3 441a',
    0x31: 'push2 wt3 441c',
    0x32: 'push2 wt3 441e',
    0x33: 'push2 wt3 4420',
    0x34: 'push2 wt3 4422',
    0x35: 'push2 wt3 4424',
    0x36: 'push2 wt3 4426',
    0x37: 'push2 wt3 4428',
    0x38: 'push2 wt3 442a',
    0x39: 'push2 wt3 442c',
    0x3a: 'push2 wt3 442e',
    0x3b: 'push2 wt3 4430',
    0x3c: 'push2 wt3 4432',
    0x3d: 'push2 wt3 4434',
    0x3e: 'push2 wt3 4436',
    0x3f: 'push2 wt3 4438',
    0x40: 'push2 wt3 443a',
    0x41: 'push2 wt3 443c',
    0x42: 'push2 wt3 443e',
    0x43: 'push2 wt3 4440',
    0x44: 'push2 wt3 4442',
    0x45: 'push2 wt3 4444',
    0x46: 'push2 wt3 4446',
    0x47: 'push wt1 4300',
    0x48: 'push wt1 4302',
    0x49: 'push wt1 4304',
    0x4a: 'push wt1 4306',
    0x4b: 'push wt1 4308',
    0x4c: 'push wt1 430a',
    0x4d: 'push wt1 430c',
    0x4e: 'push wt1 430e',
    0x4f: 'push wt1 4310',
    0x50: 'push wt1 4312',
    0x51: 'push wt1 4314',
    0x52: 'push wt1 4316',
    0x53: 'push wt1 4318',
    0x54: 'push wt1 431a',
    0x55: 'push wt1 431c',
    0x56: 'push wt1 431e',
    0x57: 'push wt1 4320',
    0x58: 'push wt1 4322',
    0x59: 'push wt1 4324',
    0x5a: 'push wt1 4326',
    0x5b: 'push wt1 4328',
    0x5c: 'push wt1 432a',
    0x5d: 'push wt1 432c',
    0x5e: 'push wt1 432e',
    0x5f: 'push wt1 4330',
    0x60: 'push wt1 4332',
    0x61: 'push wt1 4334',
    0x62: 'push wt1 4336',
    0x63: 'push wt1 4338',
    0x64: 'push wt1 433a',
    0x65: 'push wt1 433c',
    0x66: 'push wt1 433e',
    0x67: 'push wt1 4340',
    0x68: 'push wt1 4342',
    0x69: 'push wt1 4344',
    0x6a: 'push wt1 4346',
    0x6b: 'push wt1 4348',
    0x6c: 'push wt1 434a',
    0x6d: 'push wt1 434c',
    0x6e: 'push wt1 434e',
    0x6f: 'push wt1 4350',
    0x70: 'push wt1 4352',
    0x71: 'push wt1 4354',
    0x72: 'push wt1 4356',
    0x73: 'push wt1 4358',
    0x74: 'push wt1 435a',
    0x75: 'push wt1 435c',
    0x76: 'push wt1 435e',
    0x77: 'push wt1 4360',
    0x78: 'push wt1 4362',
    0x79: 'push wt1 4364',
    0x7a: 'push wt1 4366',
    0x7b: 'push wt1 4368',
    0x7c: 'push wt1 436a',
    0x7d: 'push wt1 436c',
    0x7e: 'push wt1 436e',
    0x7f: 'push wt1 4370',
    0x80: 'push wt1 4372',
    0x81: 'push wt1 4374',
    0x82: 'push wt1 4376',
    0x83: 'push wt1 4378',
    0x84: 'push wt1 437a',
    0xa6: 'Code follows',
    0xa7: 'Return',
    0xa8: 'gosub 7670',
    0xa9: 'gosub 7673',
    0xaa: 'gosub 7676',
    0xab: 'gosub 5f1f',
    0xac: 'gosub 5f5b',
    0xad: 'gosub 7877',
    0xae: 'gosub 77ec',
    0xaf: 'gosub 5f67',
    0xb0: 'gosub 782b',
    0xb1: 'gosub 77a7',
    0xb2: 'gosub 5f63',
    0xb3: 'gosub 798a',
    0xb4: 'gosub 5f15',
    0xb5: 'gosub 77aa',
    0xb6: 'gosub 5f3b',
    0xb7: 'gosub 5f2b',
    0xb8: 'gosub 5f46',
    0xb9: 'gosub 7695',
    0xba: 'gosub 76a3',
    0xbb: 'gosub 77bc',
    0xbc: 'gosub 5f77',
    0xbd: 'gosub 7953',
    0xbe: 'gosub 77e5',
    0xbf: 'gosub 785d',
    0xc0: 'gosub 7980',
    0xc1: 'gosub 7895',
    0xc2: 'gosub 5f11',
    0xc3: 'gosub 76b1',
    0xc4: 'gosub 79fd',
    0xc5: 'gosub 7a64',
    0xc6: 'gosub 7a68',
    0xc7: 'gosub 7a69',
  }

  def __init__(self, dbg):
    self.dbg = dbg

  def run(self):
    """Run the debugging until the end."""
    self.dbg.add_breakpoint('5a19', self.fetch_opcode)
    self.dbg.run()

  def fetch_opcode(self):
    self.dbg.get_registers()
    a = self.dbg.get_reg_a()
    bc = self.dbg.get_reg_bc()
    rest = ''
    if a in self.opcode_table:
      rest = f' ({self.opcode_table[a]})'

    print(f'Fetch opcode {a:02x} from {bc:04x}{rest}')
